<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Panel Pro ‚Ä¢ Radio Coravox</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Roboto,Segoe UI,Arial,sans-serif;
      background:#070707;color:#fff;min-height:100vh;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border:1px solid rgba(245,200,91,.18);
      border-radius:14px;background:rgba(0,0,0,.35);
      box-shadow:0 0 18px rgba(0,0,0,.55);margin-bottom:14px;
    }
    .brand{font-weight:900;letter-spacing:.06em;color:#f5c85b}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(245,200,91,.25);
      background:rgba(0,0,0,.25);color:#fff;font-size:12px
    }
    .pill b{color:#f5c85b}
    .btn{
      border:none;border-radius:12px;padding:10px 12px;
      font-weight:900;cursor:pointer;background:#f5c85b;color:#000;
      box-shadow:0 0 10px rgba(0,0,0,.55);
    }
    .btn.secondary{
      background:rgba(245,200,91,.12);color:#f5c85b;
      border:1px solid rgba(245,200,91,.35);box-shadow:none;
    }
    .btn.danger{
      background:rgba(255,107,107,.18);color:#ff7a7a;
      border:1px solid rgba(255,107,107,.35);box-shadow:none;
    }
    .btn.small{padding:7px 9px;border-radius:10px;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid rgba(245,200,91,.18);
      border-radius:14px;background:rgba(0,0,0,.35);
      box-shadow:0 0 18px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .card h3{
      padding:12px 14px;border-bottom:1px solid rgba(245,200,91,.14);
      font-size:14px;color:#fff;display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card .body{padding:12px 14px}
    .muted{opacity:.82;color:#fff;font-size:12px}
    .field{
      width:100%;background:#000;border:1px solid rgba(245,200,91,.28);
      border-radius:12px;padding:10px 12px;color:#f5c85b;outline:none;
    }
    .field::placeholder{color:rgba(245,200,91,.55)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.split{grid-template-columns:1fr}}
    .list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto;padding-right:6px}
    .item{
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px;
      padding:10px;border-radius:12px;background:rgba(0,0,0,.25);
      border:1px solid rgba(245,200,91,.12);
    }
    .item b{color:#fff}
    .badge{
      font-size:11px;font-weight:900;padding:5px 8px;border-radius:999px;
      border:1px solid rgba(245,200,91,.25);background:rgba(245,200,91,.12);
      color:#f5c85b;white-space:nowrap
    }
    .badge.on{border-color:rgba(157,255,122,.35);background:rgba(157,255,122,.12);color:#9dff7a}
    .badge.off{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.12);color:#ff6b6b}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .tab{
      border:1px solid rgba(245,200,91,.18);
      background:rgba(0,0,0,.25);
      color:#fff;border-radius:999px;padding:8px 10px;
      font-weight:900;font-size:12px;cursor:pointer
    }
    .tab.active{background:#f5c85b;color:#000;border-color:#f5c85b}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.88);border:1px solid rgba(245,200,91,.25);
      color:#fff;border-radius:14px;padding:10px 12px;
      box-shadow:0 0 20px rgba(0,0,0,.75);
      display:none;z-index:99999;max-width:92%;text-align:center;font-size:13px;
    }
    .hr{height:1px;background:rgba(245,200,91,.14);margin:10px 0}
    .toggle{
      display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;
      border:1px solid rgba(245,200,91,.12);background:rgba(0,0,0,.25);color:#fff;
    }
    .toggle input{transform:scale(1.1)}
    textarea.field{min-height:38px;resize:vertical;color:#fff}
    .miniBtn{
      border:1px solid rgba(245,200,91,.25);
      background:rgba(0,0,0,.35);
      color:#f5c85b;border-radius:10px;
      padding:7px 9px;font-weight:900;cursor:pointer;font-size:12px;
    }
    .miniBtn.danger{border-color:rgba(255,107,107,.35);color:#ff7a7a}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#fff;opacity:.9}
    .twoCol{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media(max-width:980px){.twoCol{grid-template-columns:1fr}}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">üéõÔ∏è Panel Pro ‚Ä¢ Radio Coravox</div>
    <div class="row">
      <div id="who" class="pill">No autenticado</div>
      <button id="btnLogout" class="btn secondary small" style="display:none">Salir</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginView" class="card">
    <h3>üîê Iniciar sesi√≥n <span class="badge">Firebase Auth</span></h3>
    <div class="body">
      <div class="split">
        <input id="email" class="field" type="email" placeholder="Correo" value="vis-party@hotmail.com" />
        <input id="pass"  class="field" type="password" placeholder="Contrase√±a" />
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnLogin" class="btn">Entrar</button>
        <button id="btnReset" class="btn secondary">Olvid√© mi contrase√±a</button>
        <span id="loginMsg" class="muted"></span>
      </div>
      <div class="hr"></div>
      <div class="muted">
        Roles: Admin (t√∫) y DJs por email.  
        Admin: control total. DJs: moderaci√≥n por programa.
      </div>
    </div>
  </div>

  <!-- DASH -->
  <div id="dashView" style="display:none">

    <div class="tabs">
      <button class="tab active" data-tab="home">Dashboard</button>
      <button class="tab" data-tab="ads">Gotas / Anuncios</button>
      <button class="tab" data-tab="programs">Programas</button>
      <button class="tab" data-tab="djs">DJs</button>
      <button class="tab" data-tab="moderation">Moderaci√≥n</button>
    </div>

    <!-- DASHBOARD -->
    <div class="grid tabPane" data-pane="home">

      <div class="card">
        <h3>üì° ON AIR <span class="badge" id="onAirBadge">cargando‚Ä¶</span></h3>
        <div class="body">
          <div class="row">
            <div class="pill">Programa: <b id="onAirName">‚Äî</b></div>
            <div class="pill">ID: <b id="onAirId">‚Äî</b></div>
            <div class="pill">TZ: <b>America/New_York</b></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="btnForceAutodj" class="btn secondary small">Forzar AutoDJ</button>
            <button id="btnRecalc" class="btn secondary small">Recalcular ahora</button>
            <div class="muted">Autom√°tico por horario mientras el panel est√© abierto.</div>
          </div>
          <div class="hr"></div>
          <div class="twoCol">
            <div>
              <div class="muted" style="margin-bottom:6px">Conectados (programa actual)</div>
              <div class="row">
                <div class="pill">Conectados: <b id="onAirPresenceCount">0</b></div>
                <button id="btnRefreshPresence" class="btn secondary small">Refrescar</button>
              </div>
              <div id="presenceList" class="list" style="margin-top:10px;max-height:220px"></div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:6px">Top Fans (programa actual)</div>
              <div class="row">
                <button id="btnResetTopfansProgram" class="btn danger small">Reset TopFans</button>
              </div>
              <div id="topfansList" class="list" style="margin-top:10px;max-height:220px"></div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row">
            <button id="btnClearChatProgram" class="btn danger small">Clear Chat</button>
            <span class="muted">Limpia el chat del programa actual (solo admin).</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>‚öôÔ∏è Config global (config/global) <span id="cfgBadge" class="badge">‚Äî</span></h3>
        <div class="body">
          <div class="split">
            <label class="toggle"><input id="togChat" type="checkbox"> Chat habilitado</label>
            <label class="toggle"><input id="togLikes" type="checkbox"> Likes habilitados</label>
            <label class="toggle"><input id="togPresence" type="checkbox"> Presence habilitado</label>
            <label class="toggle"><input id="togAds" type="checkbox"> Gotas habilitadas</label>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="btnSaveCfg" class="btn">Guardar config</button>
            <button id="btnReloadCfg" class="btn secondary">Recargar</button>
            <span class="muted">*Esto no cambia la app si tu app no lo respeta (pero lo dejaremos listo).</span>
          </div>
          <div class="hr"></div>
          <div class="muted">
            Estado: <span class="kbd">adsEnabled</span>, <span class="kbd">adsIntervalSec</span>, <span class="kbd">adsMessages</span>.
          </div>
        </div>
      </div>

    </div>

    <!-- ADS -->
    <div class="grid tabPane" data-pane="ads" style="display:none">
      <div class="card">
        <h3>üíß Gotas / mensajes (globales) <span class="badge">secuencia</span></h3>
        <div class="body">
          <div class="split">
            <label class="toggle"><input id="adsEnabled" type="checkbox"> Activar gotas</label>
            <div>
              <div class="muted" style="margin-bottom:6px">Intervalo (segundos)</div>
              <input id="adsIntervalSec" class="field" type="number" min="5" step="1" placeholder="20">
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <input id="newAdMsg" class="field" placeholder="Nuevo mensaje‚Ä¶" />
            <button id="btnAddAdMsg" class="btn secondary">Agregar</button>
          </div>

          <div id="adsList" class="list" style="margin-top:10px"></div>

          <div class="row" style="margin-top:10px">
            <button id="btnSaveAds" class="btn">Guardar gotas</button>
            <button id="btnForceReloadAds" class="btn secondary">Forzar refresco</button>
            <span id="adsMsg" class="muted"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>üß† Nota <span class="badge">importante</span></h3>
        <div class="body muted">
          Las gotas en la app deben leer <b>config/global</b>:<br>
          <span class="kbd">adsEnabled</span>, <span class="kbd">adsIntervalSec</span>, <span class="kbd">adsMessages</span><br><br>
          En este panel, la lista sale <b>en orden</b> (secuencia fija).
        </div>
      </div>
    </div>

    <!-- PROGRAMS -->
    <div class="grid tabPane" data-pane="programs" style="display:none">
      <div class="card">
        <h3>üóìÔ∏è Programas <span class="badge">por DJ</span></h3>
        <div class="body">
          <div class="row" style="margin-bottom:10px">
            <button id="btnReloadPrograms" class="btn secondary small">Recargar</button>
            <span class="muted">Crea programas para vender horas. El sistema ‚ÄúON AIR‚Äù los activa por horario.</span>
          </div>

          <!-- Crear/editar -->
          <div class="card" style="background:rgba(0,0,0,.22);border-color:rgba(245,200,91,.12)">
            <h3>‚ûï Crear / Editar programa <span class="badge" id="progMode">nuevo</span></h3>
            <div class="body">
              <div class="split">
                <input id="progId" class="field" placeholder="ID (ej: dj_maria_20_21)" />
                <input id="progName" class="field" placeholder="Nombre (ej: DJ Maria Live)" />
              </div>
              <div class="split" style="margin-top:10px">
                <input id="progDjId" class="field" placeholder="djId (ej: dj_maria) o autodj" />
                <label class="toggle"><input id="progEnabled" type="checkbox"> Enabled</label>
              </div>
              <div class="split" style="margin-top:10px">
                <input id="progStart" class="field" placeholder="Inicio (HH:MM) ej 20:00" />
                <input id="progEnd" class="field" placeholder="Fin (HH:MM) ej 21:00" />
              </div>
              <div class="muted" style="margin-top:10px">D√≠as de la semana (0=Dom ‚Ä¶ 6=Sab). Ej: 1,2,3,4,5</div>
              <input id="progDays" class="field" placeholder="daysOfWeek ej: 0,1,2,3,4,5,6" style="margin-top:6px" />

              <div class="row" style="margin-top:10px">
                <button id="btnSaveProgram" class="btn">Guardar</button>
                <button id="btnClearProgramForm" class="btn secondary">Limpiar</button>
                <span id="progMsg" class="muted"></span>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div id="programsList" class="list"></div>
        </div>
      </div>

      <div class="card">
        <h3>ü§ñ AutoDJ base <span class="badge">recomendado</span></h3>
        <div class="body muted">
          Siempre debe existir el programa <b>autodj</b> habilitado (00:00‚Äì23:59, todos los d√≠as).  
          As√≠, cuando no haya un DJ, el sistema vuelve a AutoDJ autom√°ticamente.
        </div>
      </div>
    </div>

    <!-- DJs -->
    <div class="grid tabPane" data-pane="djs" style="display:none">
      <div class="card">
        <h3>üéß DJs <span class="badge">roles y permisos</span></h3>
        <div class="body">
          <div class="row">
            <button id="btnReloadDjs" class="btn secondary small">Recargar</button>
            <span class="muted">Admin crea DJs en Firebase Auth y aqu√≠ guarda perfil/permisos.</span>
          </div>

          <div class="card" style="background:rgba(0,0,0,.22);border-color:rgba(245,200,91,.12);margin-top:10px">
            <h3>‚ûï Crear / Editar DJ <span class="badge" id="djMode">nuevo</span></h3>
            <div class="body">
              <div class="split">
                <input id="djId" class="field" placeholder="djId (ej: dj_maria)" />
                <input id="djName" class="field" placeholder="Nombre art√≠stico (DJ Maria)" />
              </div>
              <div class="split" style="margin-top:10px">
                <input id="djEmail" class="field" placeholder="Email (de Firebase Auth)" />
                <label class="toggle"><input id="djActive" type="checkbox"> Activo</label>
              </div>

              <div class="hr"></div>
              <div class="muted">Permisos (DJs NO pueden limpiar chat):</div>

              <div class="split" style="margin-top:10px">
                <label class="toggle"><input id="pChatModerate" type="checkbox"> Moderar chat</label>
                <label class="toggle"><input id="pTopfansReset" type="checkbox"> Reset TopFans (su programa)</label>
              </div>
              <div class="split" style="margin-top:10px">
                <label class="toggle"><input id="pBanUsers" type="checkbox"> Ban / Unban</label>
                <label class="toggle"><input id="pAnnouncements" type="checkbox"> Anuncios (Sistema)</label>
              </div>

              <div class="row" style="margin-top:10px">
                <button id="btnSaveDj" class="btn">Guardar DJ</button>
                <button id="btnClearDjForm" class="btn secondary">Limpiar</button>
                <span id="djMsg" class="muted"></span>
              </div>
            </div>
          </div>

          <div class="hr"></div>
          <div id="djsList" class="list"></div>
        </div>
      </div>

      <div class="card">
        <h3>üîê Importante <span class="badge">seguridad</span></h3>
        <div class="body muted">
          Este panel usa Firebase Auth.  
          - El DJ debe existir como usuario en <b>Authentication</b> (Email/Password).  
          - Aqu√≠ guardamos su perfil y permisos en <b>djs/{djId}</b>.
        </div>
      </div>
    </div>

    <!-- MODERATION -->
    <div class="grid tabPane" data-pane="moderation" style="display:none">
      <div class="card">
        <h3>üõ°Ô∏è Moderaci√≥n por programa <span class="badge">chat/topfans</span></h3>
        <div class="body">
          <div class="row">
            <div class="pill">Programa actual: <b id="modCurrentProgram">‚Äî</b></div>
            <select id="programSelect" class="field" style="max-width:320px">
              <option value="">(cargando‚Ä¶)</option>
            </select>
            <button id="btnLoadProgramData" class="btn secondary small">Cargar</button>
          </div>

          <div class="hr"></div>

          <div class="twoCol">
            <div class="card" style="background:rgba(0,0,0,.22);border-color:rgba(245,200,91,.12)">
              <h3>üí¨ Chat del programa <span class="badge">borrar msg</span></h3>
              <div class="body">
                <div class="row" style="margin-bottom:8px">
                  <button id="btnRefreshChat" class="btn secondary small">Refrescar</button>
                  <button id="btnClearChatSelected" class="btn danger small">Clear Chat</button>
                </div>
                <div id="chatModList" class="list" style="max-height:360px"></div>
              </div>
            </div>

            <div class="card" style="background:rgba(0,0,0,.22);border-color:rgba(245,200,91,.12)">
              <h3>‚ù§Ô∏è TopFans del programa <span class="badge">reset</span></h3>
              <div class="body">
                <div class="row" style="margin-bottom:8px">
                  <button id="btnRefreshTopfans" class="btn secondary small">Refrescar</button>
                  <button id="btnResetTopfansSelected" class="btn danger small">Reset TopFans</button>
                </div>
                <div id="topfansModList" class="list" style="max-height:360px"></div>
              </div>
            </div>
          </div>

          <div class="hr"></div>
          <div class="muted">
            Nota: los datos por programa viven en:
            <span class="kbd">programs/{programId}/chat</span> y
            <span class="kbd">programs/{programId}/topfans</span>.
          </div>
        </div>
      </div>

      <div class="card">
        <h3>üü¢ Conectados (programa) <span class="badge">presence</span></h3>
        <div class="body">
          <div class="row">
            <button id="btnRefreshPresenceSelected" class="btn secondary small">Refrescar</button>
            <div class="pill">Conectados: <b id="presenceSelectedCount">0</b></div>
          </div>
          <div id="presenceSelectedList" class="list" style="margin-top:10px;max-height:340px"></div>
        </div>
      </div>
    </div>

  </div><!-- dashView -->
</div><!-- wrap -->

<div id="toast" class="toast"></div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  /***********************
   * FIREBASE CONFIG (tuya)
   ***********************/
  var firebaseConfig = {
    apiKey: "AIzaSyC8jq2iODj6DwfTSktgZ7ia84oeMxxPjNE",
    authDomain: "coravox-602a0.firebaseapp.com",
    projectId: "coravox-602a0",
    storageBucket: "coravox-602a0.firebasestorage.app",
    messagingSenderId: "629472102664",
    appId: "1:629472102664:web:56e539689983458ada84bd"
  };
  firebase.initializeApp(firebaseConfig);
  var auth = firebase.auth();
  var db = firebase.firestore();
  var auth = firebase.auth();
  
  var cfgRef = db.collection("config").doc("global");
var auth = firebase.auth();
// Login an√≥nimo para que Firestore Rules permitan escribir desde la app
auth.signInAnonymously().catch(function(e){
  console.log("Anonymous auth error:", e);
});
  });
var programKey = "autodj"; // fallback
var messagesRef = null;
var likesRef = null;
var presenceRef = null;

async function initProgramRefs() {
  const snap = await cfgRef.get();
  const cfg = snap.exists ? snap.data() : {};

  // convierte "AutoDJ Coravox" -> "autodj_coravox"
  const raw = (cfg.currentProgram || "AutoDJ Coravox").toString().trim().toLowerCase();
  programKey = raw.replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "");
  if (!programKey) programKey = "autodj";

  // ‚úÖ TODO por programa (una sola fuente de verdad)
  const base = db.collection("programs").doc(programKey);

  messagesRef  = base.collection("mensajes-chat");
  likesRef     = base.collection("likes-ranking");
  presenceRef  = base.collection("presence");
}

  /***********************
