<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Panel Admin ‚Ä¢ Radio Coravox</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Roboto,Segoe UI,Arial,sans-serif;
      background:#070707; color:#f5c85b;
      min-height:100vh;
    }
    a{color:#7ad9ff;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border:1px solid rgba(245,200,91,.18);
      border-radius:14px;background:rgba(0,0,0,.35);
      box-shadow:0 0 18px rgba(0,0,0,.55);
      margin-bottom:14px;
    }
    .brand{font-weight:900;letter-spacing:.06em}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(245,200,91,.25);
      background:rgba(0,0,0,.25); color:#fff;
      font-size:12px;
    }
    .btn{
      border:none;border-radius:12px;padding:10px 12px;
      font-weight:900;cursor:pointer;
      background:#f5c85b;color:#000;
      box-shadow:0 0 10px rgba(0,0,0,.5);
    }
    .btn.secondary{
      background:rgba(245,200,91,.12); color:#f5c85b;
      border:1px solid rgba(245,200,91,.35);
      box-shadow:none;
    }
    .btn.danger{
      background:rgba(255,107,107,.15); color:#ff6b6b;
      border:1px solid rgba(255,107,107,.35);
      box-shadow:none;
    }
    .btn.small{padding:7px 9px;border-radius:10px;font-size:12px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      border:1px solid rgba(245,200,91,.18);
      border-radius:14px;background:rgba(0,0,0,.35);
      box-shadow:0 0 18px rgba(0,0,0,.55);
      overflow:hidden;
      min-height:140px;
    }
    .card h3{
      padding:12px 14px;
      border-bottom:1px solid rgba(245,200,91,.14);
      font-size:14px; color:#fff;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card .body{padding:12px 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{opacity:.85;color:#fff}
    .smalltxt{font-size:12px;opacity:.9;color:#fff}
    .field{
      width:100%;
      background:#000;border:1px solid rgba(245,200,91,.28);
      border-radius:12px;padding:10px 12px;color:#f5c85b;
      outline:none;
    }
    .field::placeholder{color:rgba(245,200,91,.55)}
    .split{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){
      .split{grid-template-columns:1fr}
    }
    .list{
      display:flex;flex-direction:column;gap:8px;
      max-height:320px;overflow:auto;padding-right:6px;
    }
    .item{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:10px 10px;border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(245,200,91,.12);
    }
    .item b{color:#fff}
    .badge{
      font-size:11px;font-weight:900;
      padding:5px 8px;border-radius:999px;
      border:1px solid rgba(245,200,91,.25);
      background:rgba(245,200,91,.12);
      color:#f5c85b;
      white-space:nowrap;
    }
    .badge.on{border-color:rgba(157,255,122,.35);background:rgba(157,255,122,.12);color:#9dff7a}
    .badge.off{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.12);color:#ff6b6b}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.88);
      border:1px solid rgba(245,200,91,.25);
      color:#fff;border-radius:14px;
      padding:10px 12px;
      box-shadow:0 0 20px rgba(0,0,0,.75);
      display:none;z-index:99999;
      max-width:92%; text-align:center;
      font-size:13px;
    }
    .divider{height:1px;background:rgba(245,200,91,.14);margin:10px 0}
    .toggle{
      display:flex;align-items:center;gap:10px;
      padding:10px;border-radius:12px;
      border:1px solid rgba(245,200,91,.12);
      background:rgba(0,0,0,.25);
      color:#fff;
    }
    .toggle input{transform:scale(1.1)}
    .loginCard{
      max-width:520px;margin:9vh auto 0;
    }
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;color:#fff;opacity:.9;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(245,200,91,.12);
      border-radius:12px;
      padding:10px;
      overflow:auto;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">üéõÔ∏è Panel Admin ‚Ä¢ Radio Coravox</div>
      <div class="row">
        <div id="who" class="pill">No autenticado</div>
        <button id="btnLogout" class="btn secondary small" style="display:none">Salir</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginView" class="card loginCard">
      <h3>üîê Iniciar sesi√≥n</h3>
      <div class="body">
        <div class="smalltxt muted" style="margin-bottom:10px">
          Solo el admin autorizado puede entrar.
        </div>
        <div class="split">
          <input id="email" class="field" type="email" placeholder="Correo" value="vis-party@hotmail.com" />
          <input id="pass" class="field" type="password" placeholder="Contrase√±a" />
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnLogin" class="btn">Entrar</button>
          <button id="btnReset" class="btn secondary">Olvid√© mi contrase√±a</button>
        </div>
        <div class="divider"></div>
        <div class="smalltxt muted">
          Si te falla el login, revisa en Firebase ‚Üí Authentication que ‚ÄúCorreo/contrase√±a‚Äù est√© habilitado.
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashView" style="display:none">
      <div class="grid">

        <!-- CONFIG GLOBAL -->
        <div class="card">
          <h3>
            ‚öôÔ∏è Configuraci√≥n global (config/global)
            <span id="cfgBadge" class="badge">cargando‚Ä¶</span>
          </h3>
          <div class="body">
            <div class="row" style="margin-bottom:10px">
              <div class="pill">DJ activo: <b id="activeDjLabel" style="color:#fff">‚Äî</b></div>
              <button id="btnReloadCfg" class="btn secondary small">Recargar</button>
            </div>

            <div class="split">
              <div class="toggle">
                <input id="togChat" type="checkbox" />
                <label for="togChat"><b>Chat</b> habilitado</label>
              </div>
              <div class="toggle">
                <input id="togLikes" type="checkbox" />
                <label for="togLikes"><b>Likes</b> habilitados</label>
              </div>
              <div class="toggle">
                <input id="togReq" type="checkbox" />
                <label for="togReq"><b>Peticiones</b> habilitadas</label>
              </div>
              <div class="toggle">
                <input id="togPresence" type="checkbox" />
                <label for="togPresence"><b>Presence</b> habilitado</label>
              </div>
              <div class="toggle">
                <input id="togMensajes de Gotas" type="checkbox" />
                <label for="togMensajes de Gotas"><b>Mensajes de Gotas</b> habilitado</label>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <button id="btnSaveCfg" class="btn">Guardar cambios</button>
              <span class="smalltxt muted">*Se guarda en config/global</span>
            </div>

            <div class="divider"></div>
            <div class="smalltxt muted">
              Nota: Estos switches solo controlan lo que t√∫ decidas respetar desde la app (si ya lo tienes conectado).
            </div>
          </div>
        </div>

        <!-- DJ MANAGEMENT -->
        <div class="card">
          <h3>
            üéß DJs / Programas (djs/*)
            <span class="badge">activar / poner en vivo</span>
          </h3>
          <div class="body">
            <div class="row" style="margin-bottom:10px">
              <input id="djSearch" class="field" placeholder="Buscar DJ..." />
              <button id="btnReloadDjs" class="btn secondary small">Recargar</button>
            </div>
            <div id="djList" class="list"></div>
            <div class="divider"></div>
            <div class="smalltxt muted">
              ‚ÄúActivar‚Äù = cambia el campo <b>active</b> en djs/{id}.  
              ‚ÄúPoner DJ activo‚Äù = escribe <b>activeDj</b> y <b>currentProgram</b> en config/global.
            </div>
          </div>
        </div>

        <!-- CONNECTED USERS -->
        <div class="card">
          <h3>
            üü¢ Conectados (presence)
            <span id="onlineBadge" class="badge">0</span>
          </h3>
          <div class="body">
            <div class="row" style="margin-bottom:10px">
              <button id="btnReloadPresence" class="btn secondary small">Refrescar</button>
              <span class="smalltxt muted">Se muestra quien ‚Äúpingue√≥‚Äù en los √∫ltimos ~90s</span>
            </div>
            <div id="presenceList" class="list"></div>
            <div class="divider"></div>
            <div class="smalltxt muted">
              Si aqu√≠ no aparece nadie, revisa que tu app est√© enviando <b>lastSeen</b> a /presence.
            </div>
          </div>
        </div>

        <!-- CHAT MODERATION -->
        <div class="card">
          <h3>
            üí¨ Chat (mensajes-chat)
            <span class="badge">moderar</span>
          </h3>
          <div class="body">
            <div class="row" style="margin-bottom:10px">
              <button id="btnReloadChat" class="btn secondary small">Recargar</button>
              <button id="btnClearChat" class="btn danger small">üßπ ClearChat</button>
              <span class="smalltxt muted">Borra mensajes (admin)</span>
            </div>
            <div id="chatList" class="list"></div>
            <div class="divider"></div>
            <div class="smalltxt muted">
              ‚ÄúBorrar‚Äù elimina el documento real en Firestore.
            </div>
          </div>
        </div>

        <!-- TOP FANS -->
        <div class="card">
          <h3>
            ‚ù§Ô∏è Top Fans (likes-ranking)
            <span class="badge">reset</span>
          </h3>
          <div class="body">
            <div class="row" style="margin-bottom:10px">
              <button id="btnReloadFans" class="btn secondary small">Recargar</button>
              <button id="btnResetFans" class="btn danger small">‚ôª ResetFans</button>
              <span class="smalltxt muted">Borra todos los likes</span>
            </div>
            <div id="fansList" class="list"></div>
          </div>
        </div>

    <!-- ADS MESSAGES -->
    <div class="card">
      <h3>üíß Mensajes de Gotas (secuencia) <span class="badge">config/global.adsMessages</span></h3>
      <div class="body">
        <div class="row">
          <input id="newAdMsg" class="field" placeholder="Nuevo mensaje‚Ä¶" />
          <button id="btnAddAdMsg" class="btn secondary">Agregar</button>
        </div>
        <div id="adsList" class="list" style="margin-top:12px"></div>
        <div class="muted" style="margin-top:10px">Se muestran en el orden exacto. Puedes subir/bajar.</div>
      </div>
    </div>

        <!-- LOGS / DEBUG -->
        <div class="card">
          <h3>üßæ Estado / Debug <span class="badge">√∫til</span></h3>
          <div class="body">
            <div class="smalltxt muted" style="margin-bottom:8px">
              Si algo falla, mira aqu√≠ el √∫ltimo estado:
            </div>
            <div id="debug" class="code">Listo.</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase v8 (igual que tu app) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    /***********************
     * ‚úÖ CONFIG FIREBASE (TUYO)
     ***********************/
    var firebaseConfig = {
      apiKey: "AIzaSyC8jq2iODj6DwfTSktgZ7ia84oeMxxPjNE",
      authDomain: "coravox-602a0.firebaseapp.com",
      projectId: "coravox-602a0",
      storageBucket: "coravox-602a0.firebasestorage.app",
      messagingSenderId: "629472102664",
      appId: "1:629472102664:web:56e539689983458ada84bd"
    };
    firebase.initializeApp(firebaseConfig);
    var auth = firebase.auth();
    var db = firebase.firestore();

    /***********************
     * ‚úÖ ADMIN AUTORIZADO
     ***********************/
    var ADMIN_EMAILS = ["vis-party@hotmail.com"];

    /***********************
     * ‚úÖ REFS
     ***********************/
    var cfgRef      = db.collection("config").doc("global");
    var djsRef      = db.collection("djs");
    var presenceRef = db.collection("presence");
    var chatRef     = db.collection("mensajes-chat");
    var likesRef    = db.collection("likes-ranking");

    /***********************
     * UI
     ***********************/
    var loginView = document.getElementById("loginView");
    var dashView  = document.getElementById("dashView");
    var who       = document.getElementById("who");
    var btnLogout = document.getElementById("btnLogout");

    var email = document.getElementById("email");
    var pass  = document.getElementById("pass");
    var btnLogin = document.getElementById("btnLogin");
    var btnReset = document.getElementById("btnReset");

    var activeDjLabel = document.getElementById("activeDjLabel");
    var cfgBadge = document.getElementById("cfgBadge");
    var btnReloadCfg = document.getElementById("btnReloadCfg");
    var btnSaveCfg = document.getElementById("btnSaveCfg");

    var togChat = document.getElementById("togChat");
    var togLikes = document.getElementById("togLikes");
    var togReq = document.getElementById("togReq");
    var togPresence = document.getElementById("togPresence");

    var djSearch = document.getElementById("djSearch");
    var btnReloadDjs = document.getElementById("btnReloadDjs");
    var djList = document.getElementById("djList");

    var onlineBadge = document.getElementById("onlineBadge");
    var btnReloadPresence = document.getElementById("btnReloadPresence");
    var presenceList = document.getElementById("presenceList");

    var btnReloadChat = document.getElementById("btnReloadChat");
    var btnClearChat = document.getElementById("btnClearChat");
    var chatList = document.getElementById("chatList");

    var btnReloadFans = document.getElementById("btnReloadFans");
    var btnResetFans = document.getElementById("btnResetFans");
    var fansList = document.getElementById("fansList");

    var debugBox = document.getElementById("debug");
    var toast = document.getElementById("toast");

    function logDebug(msg){
      debugBox.textContent = (new Date()).toLocaleString() + " ‚Ä¢ " + msg;
      console.log(msg);
    }
    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=>toast.style.display="none", 2600);
    }

    /***********************
     * AUTH
     ***********************/
    btnLogin.addEventListener("click", async function(){
      try{
        await auth.signInWithEmailAndPassword(email.value.trim(), pass.value);
      }catch(e){
        showToast("Error login: " + (e.message||e));
        logDebug("LOGIN ERROR: " + (e.message||e));
      }
    });

    btnReset.addEventListener("click", async function(){
      try{
        var em = email.value.trim();
        if(!em){ showToast("Escribe tu correo primero"); return; }
        await auth.sendPasswordResetEmail(em);
        showToast("Te envi√© un correo para resetear contrase√±a");
      }catch(e){
        showToast("Error reset: " + (e.message||e));
      }
    });

    btnLogout.addEventListener("click", function(){
      auth.signOut();
    });

    auth.onAuthStateChanged(async function(user){
      if(!user){
        who.textContent="No autenticado";
        btnLogout.style.display="none";
        dashView.style.display="none";
        loginView.style.display="block";
        return;
      }

      // ‚úÖ Gate por correo admin
      var em = (user.email||"").toLowerCase();
      if(ADMIN_EMAILS.indexOf(em) === -1){
        showToast("No autorizado: " + em);
        await auth.signOut();
        return;
      }

      who.textContent = "‚úÖ " + user.email;
      btnLogout.style.display="inline-flex";
      loginView.style.display="none";
      dashView.style.display="block";

      // Cargar todo
      await loadConfig();
      await loadDjs();
      await loadPresence();
      await loadChat();
      await loadFans();
      logDebug("Dashboard cargado.");
    });

    /***********************
     * CONFIG GLOBAL
     ***********************/
    var lastCfg = null;

    async function loadConfig(){
      try{
        cfgBadge.textContent = "cargando‚Ä¶";
        var snap = await cfgRef.get();
        var data = snap.exists ? snap.data() : {};
        lastCfg = data || {};

        activeDjLabel.textContent = data.activeDj || data.currentProgram || "‚Äî";

        togChat.checked = (data.chatEnabled !== false);
        togLikes.checked = (data.likesEnabled !== false);
        togReq.checked = (data.allowRequests !== false);
        togPresence.checked = (data.presenceEnabled !== false);

        cfgBadge.textContent = "ok";
        cfgBadge.className = "badge on";
        logDebug("Config/global cargado.");
      }catch(e){
        cfgBadge.textContent = "error";
        cfgBadge.className = "badge off";
        showToast("Error config: " + (e.message||e));
        logDebug("CONFIG ERROR: " + (e.message||e));
      }
    }

    btnReloadCfg.addEventListener("click", loadConfig);

    btnSaveCfg.addEventListener("click", async function(){
      try{
        await cfgRef.set({
          chatEnabled: !!togChat.checked,
          likesEnabled: !!togLikes.checked,
          allowRequests: !!togReq.checked,
          presenceEnabled: !!togPresence.checked
        }, {merge:true});
        showToast("Config guardada ‚úÖ");
        await loadConfig();
      }catch(e){
        showToast("Error guardando: " + (e.message||e));
      }
    });

    /***********************
     * DJs
     ***********************/
    var allDjs = [];

    function renderDjs(){
      var q = (djSearch.value||"").trim().toLowerCase();
      djList.innerHTML = "";
      var list = allDjs.filter(d=>{
        if(!q) return true;
        return (d.name||"").toLowerCase().includes(q) || (d.id||"").toLowerCase().includes(q);
      });

      if(list.length===0){
        djList.innerHTML = "<div class='smalltxt muted'>No hay DJs.</div>";
        return;
      }

      list.forEach(function(d){
        var row = document.createElement("div");
        row.className = "item";

        var left = document.createElement("div");
        left.innerHTML = "<b>"+escapeHtml(d.name||d.id)+"</b><div class='smalltxt muted'>id: "+escapeHtml(d.id)+" ‚Ä¢ "+escapeHtml(d.email||"")+"</div>";

        var right = document.createElement("div");
        right.className = "row";

        var badge = document.createElement("span");
        badge.className = "badge " + (d.active ? "on":"off");
        badge.textContent = d.active ? "ACTIVO":"INACTIVO";

        var btnToggle = document.createElement("button");
        btnToggle.className = "btn secondary small";
        btnToggle.textContent = d.active ? "Desactivar":"Activar";
        btnToggle.onclick = async function(){
          try{
            await djsRef.doc(d.id).set({active: !d.active},{merge:true});
            showToast("DJ actualizado ‚úÖ");
            await loadDjs();
          }catch(e){ showToast("Error DJ: " + (e.message||e)); }
        };

        var btnSet = document.createElement("button");
        btnSet.className = "btn small";
        btnSet.textContent = "Poner DJ activo";
        btnSet.onclick = async function(){
          try{
            await cfgRef.set({
              activeDj: d.name || d.id,
              currentProgram: d.name || d.id
            },{merge:true});
            showToast("DJ activo cambiado ‚úÖ");
            await loadConfig();
          }catch(e){ showToast("Error set DJ: " + (e.message||e)); }
        };

        right.appendChild(badge);
        right.appendChild(btnToggle);
        right.appendChild(btnSet);

        row.appendChild(left);
        row.appendChild(right);
        djList.appendChild(row);
      });
    }

    async function loadDjs(){
      try{
        var snap = await djsRef.get();
        allDjs = [];
        snap.forEach(doc=>{
          var d = doc.data()||{};
          allDjs.push({
            id: doc.id,
            name: d.name || doc.id,
            email: d.email || "",
            active: d.active === true
          });
        });
        allDjs.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
        renderDjs();
        logDebug("DJs cargados: " + allDjs.length);
      }catch(e){
        showToast("Error DJs: " + (e.message||e));
        logDebug("DJS ERROR: " + (e.message||e));
      }
    }
    btnReloadDjs.addEventListener("click", loadDjs);
    djSearch.addEventListener("input", renderDjs);

    /***********************
     * PRESENCE (conectados)
     ***********************/
    async function loadPresence(){
      try{
        // Leemos m√°s recientes y filtramos por "√∫ltimos 90s"
        var snap = await presenceRef.orderBy("lastSeen","desc").limit(60).get();
        var now = Date.now();
        var active = [];
        snap.forEach(doc=>{
          var d = doc.data()||{};
          var ts = d.lastSeen;
          var ms = ts && ts.toMillis ? ts.toMillis() : 0;
          if(ms && (now - ms) <= 90000){
            active.push({
              id: doc.id,
              name: d.name || doc.id,
              lastSeenMs: ms
            });
          }
        });

        onlineBadge.textContent = String(active.length);
        presenceList.innerHTML = "";

        if(active.length===0){
          presenceList.innerHTML = "<div class='smalltxt muted'>Nadie conectado (o no hay pings recientes).</div>";
          return;
        }

        active.forEach(function(u){
          var row = document.createElement("div");
          row.className = "item";
          var ago = Math.max(0, Math.floor((now - u.lastSeenMs)/1000));
          row.innerHTML = "<div><b>"+escapeHtml(u.name)+"</b><div class='smalltxt muted'>hace "+ago+"s</div></div><span class='badge on'>ONLINE</span>";
          presenceList.appendChild(row);
        });

        logDebug("Presence cargado. Online: " + active.length);
      }catch(e){
        showToast("Error presence: " + (e.message||e));
        logDebug("PRESENCE ERROR: " + (e.message||e));
      }
    }
    btnReloadPresence.addEventListener("click", loadPresence);

    // Auto refresco presence
    setInterval(function(){
      if(dashView.style.display==="block") loadPresence();
    }, 15000);

    /***********************
     * CHAT (moderar)
     ***********************/
    async function loadChat(){
      try{
        var snap = await chatRef.orderBy("creado","desc").limit(60).get();
        var arr = [];
        snap.forEach(doc=>{
          var d = doc.data()||{};
          arr.push({
            id: doc.id,
            usuario: d.usuario || "‚Äî",
            mensaje: d.mensaje || "",
            tipo: d.tipo || "mensaje",
            rol: d.rol || "user"
          });
        });
        arr.reverse();

        chatList.innerHTML = "";
        if(arr.length===0){
          chatList.innerHTML = "<div class='smalltxt muted'>No hay mensajes.</div>";
          return;
        }

        arr.forEach(function(m){
          var row = document.createElement("div");
          row.className = "item";

          var left = document.createElement("div");
          var prefix = (m.tipo==="system") ? "‚öôÔ∏è" : (m.rol==="admin" ? "‚≠ê" : "üí¨");
          left.innerHTML =
            "<b>"+prefix+" "+escapeHtml(m.usuario)+"</b>" +
            "<div class='smalltxt muted' style='margin-top:2px'>"+escapeHtml(m.mensaje)+"</div>";

          var right = document.createElement("div");
          right.className = "row";

          var btnDel = document.createElement("button");
          btnDel.className = "btn danger small";
          btnDel.textContent = "Borrar";
          btnDel.onclick = async function(){
            if(!confirm("¬øBorrar este mensaje?")) return;
            try{
              await chatRef.doc(m.id).delete();
              showToast("Mensaje borrado ‚úÖ");
              await loadChat();
            }catch(e){ showToast("Error borrar: " + (e.message||e)); }
          };

          right.appendChild(btnDel);
          row.appendChild(left);
          row.appendChild(right);
          chatList.appendChild(row);
        });

        logDebug("Chat cargado: " + arr.length);
      }catch(e){
        showToast("Error chat: " + (e.message||e));
        logDebug("CHAT ERROR: " + (e.message||e));
      }
    }
    btnReloadChat.addEventListener("click", loadChat);

    async function deleteCollectionBatch(colRef, limit){
      // borra en lotes (m√°x 500 operaciones por batch)
      var snap = await colRef.orderBy("__name__").limit(limit).get();
      if (snap.empty) return 0;

      var batch = db.batch();
      snap.docs.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      return snap.size;
    }

    btnClearChat.addEventListener("click", async function(){
      if(!confirm("¬øSeguro que quieres limpiar el chat (borrar mensajes)?")) return;
      try{
        showToast("Borrando chat‚Ä¶");
        // borramos 450 por seguridad; si hay m√°s, se puede repetir
        var deleted = await deleteCollectionBatch(chatRef, 450);
        showToast("Chat borrado: " + deleted);
        await loadChat();
      }catch(e){
        showToast("Error clearchat: " + (e.message||e));
      }
    });

    /***********************
     * TOP FANS
     ***********************/
    async function loadFans(){
      try{
        var snap = await likesRef.orderBy("likes","desc").limit(20).get();
        fansList.innerHTML = "";
        var arr = [];
        snap.forEach(doc=>{
          var d = doc.data()||{};
          arr.push({
            id: doc.id,
            usuario: d.usuario || doc.id,
            likes: d.likes || 0
          });
        });
        if(arr.length===0){
          fansList.innerHTML = "<div class='smalltxt muted'>Sin datos.</div>";
          return;
        }
        arr.forEach(function(u, idx){
          var row = document.createElement("div");
          row.className = "item";
          row.innerHTML =
            "<div><b>"+(idx+1)+". "+escapeHtml(u.usuario)+"</b></div>" +
            "<span class='badge on'>‚ù§ "+u.likes+"</span>";
          fansList.appendChild(row);
        });
        logDebug("Top fans cargado: " + arr.length);
      }catch(e){
        showToast("Error top fans: " + (e.message||e));
        logDebug("FANS ERROR: " + (e.message||e));
      }
    }
    btnReloadFans.addEventListener("click", loadFans);

    btnResetFans.addEventListener("click", async function(){
      if(!confirm("¬øSeguro que quieres RESET TOP FANS (borrar likes-ranking)?")) return;
      try{
        showToast("Reseteando TOP FANS‚Ä¶");
        var deleted = await deleteCollectionBatch(likesRef, 450);
        showToast("Top Fans borrado: " + deleted);
        await loadFans();
      }catch(e){
        showToast("Error resetfans: " + (e.message||e));
      }
    });

    /***********************
     * Helpers
     ***********************/
    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, function(m){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
      });
    }
  </script>
</body>
</html>
