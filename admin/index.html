<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Radio Coravox ‚Ä¢ Panel Pro</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Roboto,Arial,sans-serif;background:#070707;color:#fff}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .topbar{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      padding:12px 14px;border-radius:14px;border:1px solid rgba(245,200,91,.18);
      background:rgba(0,0,0,.35);box-shadow:0 0 18px rgba(0,0,0,.55);margin-bottom:14px
    }
    .brand{font-weight:900;letter-spacing:.06em;color:#f5c85b}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      border:1px solid rgba(245,200,91,.25);background:rgba(0,0,0,.25);color:#fff;font-size:12px
    }
    .pill b{color:#f5c85b}
    .btn{
      border:none;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;
      background:#f5c85b;color:#000;box-shadow:0 0 10px rgba(0,0,0,.55)
    }
    .btn.secondary{background:rgba(245,200,91,.12);color:#f5c85b;border:1px solid rgba(245,200,91,.35);box-shadow:none}
    .btn.danger{background:rgba(255,107,107,.18);color:#ff7a7a;border:1px solid rgba(255,107,107,.35);box-shadow:none}
    .btn.small{padding:7px 9px;border-radius:10px;font-size:12px}
    .card{
      border:1px solid rgba(245,200,91,.18);border-radius:14px;background:rgba(0,0,0,.35);
      box-shadow:0 0 18px rgba(0,0,0,.55);overflow:hidden;margin-bottom:14px
    }
    .card h3{
      padding:12px 14px;border-bottom:1px solid rgba(245,200,91,.14);
      font-size:14px;color:#fff;display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .body{padding:12px 14px}
    .muted{opacity:.82;color:#fff;font-size:12px;line-height:1.35}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{
      width:100%;background:#000;border:1px solid rgba(245,200,91,.28);border-radius:12px;
      padding:10px 12px;color:#f5c85b;outline:none;font-size:14px
    }
    textarea.field{color:#fff;min-height:44px;resize:vertical}
    .toggle{
      display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;
      border:1px solid rgba(245,200,91,.12);background:rgba(0,0,0,.25)
    }
    .toggle input{transform:scale(1.1)}
    .list{display:flex;flex-direction:column;gap:10px;max-height:360px;overflow:auto;padding-right:6px}
    .item{
      border:1px solid rgba(245,200,91,.12);background:rgba(0,0,0,.25);
      border-radius:14px;padding:10px;display:flex;gap:10px;align-items:flex-start;justify-content:space-between
    }
    .itemMain{flex:1;min-width:0}
    .itemBtns{display:flex;gap:8px;flex:0 0 auto;flex-wrap:wrap;justify-content:flex-end}
    .miniBtn{
      border:1px solid rgba(245,200,91,.25);background:rgba(0,0,0,.35);color:#f5c85b;
      border-radius:10px;padding:7px 9px;font-weight:900;cursor:pointer;font-size:12px
    }
    .miniBtn.danger{border-color:rgba(255,107,107,.35);color:#ff7a7a}
    .hr{height:1px;background:rgba(245,200,91,.14);margin:10px 0}
    .badge{
      font-size:11px;font-weight:900;padding:5px 8px;border-radius:999px;
      border:1px solid rgba(245,200,91,.25);background:rgba(245,200,91,.12);color:#f5c85b;white-space:nowrap
    }
    .badge.on{border-color:rgba(157,255,122,.35);background:rgba(157,255,122,.12);color:#9dff7a}
    .badge.off{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.12);color:#ff6b6b}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.88);border:1px solid rgba(245,200,91,.25);color:#fff;border-radius:14px;
      padding:10px 12px;box-shadow:0 0 20px rgba(0,0,0,.75);display:none;z-index:99999;max-width:92%;
      text-align:center;font-size:13px
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">üéõÔ∏è Panel Pro ‚Ä¢ Radio Coravox</div>
    <div class="row">
      <div id="who" class="pill">No autenticado</div>
      <button id="btnLogout" class="btn secondary small" style="display:none">Salir</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginView" class="card">
    <h3>üîê Iniciar sesi√≥n <span class="badge">Firebase Auth</span></h3>
    <div class="body">
      <div class="row">
        <div style="flex:1;min-width:220px">
          <div class="muted" style="margin-bottom:6px">Correo</div>
          <input id="email" class="field" type="email" value="vis-party@hotmail.com" />
        </div>
        <div style="flex:1;min-width:220px">
          <div class="muted" style="margin-bottom:6px">Contrase√±a</div>
          <input id="pass" class="field" type="password" placeholder="Tu contrase√±a" />
        </div>
        <div style="flex:0 0 auto">
          <button id="btnLogin" class="btn">Entrar</button>
        </div>
      </div>
      <div class="muted" id="loginMsg" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- DASH -->
  <div id="dashView" style="display:none">

    <div class="grid">
      <!-- ON AIR -->
      <div class="card">
        <h3>üì° ON AIR <span id="onAirBadge" class="badge">cargando‚Ä¶</span></h3>
        <div class="body">
          <div class="row">
            <div class="pill">Programa: <b id="onAirName">‚Äî</b></div>
            <div class="pill">Key: <b id="onAirKey">‚Äî</b></div>
          </div>
          <div class="hr"></div>
          <div class="row">
            <button id="btnForceAutodj" class="btn secondary small">Forzar AutoDJ</button>
            <button id="btnReloadOnAir" class="btn secondary small">Recargar</button>
          </div>
          <div class="muted" style="margin-top:10px">
            Se guarda en:
            <div style="margin-top:6px;opacity:.9">
              <span class="badge">config/global.currentProgram</span>
              <span class="badge">settings/current</span>
            </div>
          </div>
        </div>
      </div>

      <!-- GLOBAL CONFIG -->
      <div class="card">
        <h3>‚öôÔ∏è Config Global <span id="cfgBadge" class="badge">‚Äî</span></h3>
        <div class="body">
          <div class="row">
            <label class="toggle"><input id="togChat" type="checkbox"> Chat</label>
            <label class="toggle"><input id="togLikes" type="checkbox"> Likes/TopFans</label>
            <label class="toggle"><input id="togPresence" type="checkbox"> Presence</label>
            <label class="toggle"><input id="togRequests" type="checkbox"> Requests</label>
          </div>

          <div class="hr"></div>

          <div class="row">
            <label class="toggle"><input id="togAds" type="checkbox"> Gotas</label>
            <div style="flex:1;min-width:220px">
              <div class="muted" style="margin-bottom:6px">Intervalo (seg)</div>
              <input id="adsIntervalSec" class="field" type="number" min="5" step="1" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btnSaveCfg" class="btn">Guardar</button>
            <button id="btnReloadCfg" class="btn secondary">Recargar</button>
            <button id="btnForceReloadAds" class="btn secondary">Forzar refresco gotas</button>
          </div>

          <div class="muted" id="cfgMsg" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- ADS MESSAGES -->
    <div class="card">
      <h3>üíß Mensajes de Gotas (secuencia) <span class="badge">config/global.adsMessages</span></h3>
      <div class="body">
        <div class="row">
          <input id="newAdMsg" class="field" placeholder="Nuevo mensaje‚Ä¶" />
          <button id="btnAddAdMsg" class="btn secondary">Agregar</button>
        </div>
        <div id="adsList" class="list" style="margin-top:12px"></div>
        <div class="muted" style="margin-top:10px">Se muestran en el orden exacto. Puedes subir/bajar.</div>
      </div>
    </div>

    <!-- PROGRAMS / DJS -->
    <div class="card">
      <h3>üéôÔ∏è Programas / DJs <span class="badge">programs</span></h3>
      <div class="body">
        <div class="row">
          <input id="progName" class="field" placeholder="Nombre del programa (ej: DJ Maria 8pm)" />
          <button id="btnCreateProgram" class="btn secondary">Crear</button>
        </div>
        <div class="muted" style="margin-top:10px">
          Crear un programa solo agrega <span class="badge">programs/{programKey}</span>. Luego puedes ponerlo ON AIR.
        </div>

        <div class="hr"></div>

        <div id="programList" class="list"></div>
      </div>
    </div>

    <!-- PRESENCE -->
    <div class="card">
      <h3>üü¢ Conectados (Presence) <span id="presenceBadge" class="badge">‚Äî</span></h3>
      <div class="body">
        <div class="muted">Leyendo: <span class="badge" id="presencePath">‚Äî</span></div>
        <div class="hr"></div>
        <div id="presenceList" class="list"></div>
      </div>
    </div>

    <!-- TOOLS -->
    <div class="card">
      <h3>üßπ Herramientas (por programa ON AIR)</h3>
      <div class="body">
        <div class="row">
          <button id="btnClearChat" class="btn danger">Clear Chat</button>
          <button id="btnResetFans" class="btn danger">Reset TopFans</button>
          <button id="btnClearPresence" class="btn danger">Clear Presence</button>
        </div>

        <div class="hr"></div>

        <label class="toggle">
          <input id="togLegacyTools" type="checkbox">
          Tambi√©n borrar ‚Äúlegacy‚Äù (mensajes-chat / likes-ranking / presence ra√≠z)
        </label>

        <div class="muted" id="toolMsg" style="margin-top:10px"></div>
      </div>
    </div>

  </div><!-- dashView -->
</div><!-- wrap -->

<div id="toast" class="toast"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // ===========================
  // Firebase init
  // ===========================
  firebase.initializeApp({
    apiKey: "AIzaSyC8jq2iODj6DwfTSktgZ7ia84oeMxxPjNE",
    authDomain: "coravox-602a0.firebaseapp.com",
    projectId: "coravox-602a0"
  });

  var auth = firebase.auth();
  var db = firebase.firestore();

  var ADMIN_EMAIL = "vis-party@hotmail.com";

  function $(id){ return document.getElementById(id); }
  function toast(msg){
    $("toast").textContent = msg;
    $("toast").style.display = "block";
    setTimeout(()=>{$("toast").style.display="none";}, 2200);
  }

  function slugify(s){
    return (s||"").toString().trim().toLowerCase()
      .replace(/[^a-z0-9]+/g,"_")
      .replace(/^_+|_+$/g,"") || "autodj_coravox";
  }

  // ===========================
  // Refs
  // ===========================
  var cfgRef = db.collection("config").doc("global");
  var settingsRef = db.collection("settings").doc("current");
  var programsRef = db.collection("programs");

  // legacy
  var legacyChatRef  = db.collection("mensajes-chat");
  var legacyLikesRef = db.collection("likes-ranking");
  var legacyPresenceRef = db.collection("presence");

  // current ON AIR
  var currentProgramName = "AutoDJ Coravox";
  var currentProgramKey  = "autodj_coravox";

  function progChatRef(){ return programsRef.doc(currentProgramKey).collection("mensajes-chat"); }
  function progLikesRef(){ return programsRef.doc(currentProgramKey).collection("likes-ranking"); }
  function progPresenceRef(){ return programsRef.doc(currentProgramKey).collection("presence"); }

  // ===========================
  // Login
  // ===========================
  $("btnLogin").addEventListener("click", async function(){
    $("loginMsg").textContent = "";
    try{
      await auth.signInWithEmailAndPassword($("email").value.trim(), $("pass").value);
    }catch(e){
      $("loginMsg").textContent = "ERROR: " + (e.code||"") + " ‚Äî " + (e.message||e);
    }
  });

  $("btnLogout").addEventListener("click", ()=>auth.signOut());

  auth.onAuthStateChanged(async function(user){
    if(!user){
      $("who").textContent = "No autenticado";
      $("btnLogout").style.display="none";
      $("dashView").style.display="none";
      $("loginView").style.display="";
      return;
    }
    if((user.email||"").toLowerCase() !== ADMIN_EMAIL.toLowerCase()){
      toast("No autorizado");
      await auth.signOut();
      return;
    }

    $("who").innerHTML = "‚úÖ Admin: <b>"+user.email+"</b>";
    $("btnLogout").style.display="inline-flex";
    $("loginView").style.display="none";
    $("dashView").style.display="block";

    await ensureDefaults();
    await loadConfig();
    await loadOnAir();
    await loadPrograms();
    startPresenceWatcher();

    toast("Panel listo ‚úÖ");
  });

  // ===========================
  // Defaults (create missing docs)
  // ===========================
  async function ensureDefaults(){
    // config/global
    var c = await cfgRef.get();
    if(!c.exists){
      await cfgRef.set({
        currentProgram:"AutoDJ Coravox",
        activeDj:"AutoDJ Coravox",
        chatEnabled:true,
        likesEnabled:true,
        presenceEnabled:true,
        allowRequests:true,
        adsEnabled:true,
        adsIntervalSec:20,
        adsMessages:[
          "üíõ Gracias por escuchar Radio Coravox",
          "üéß Pide tu canci√≥n y hazla sonar",
          "üéÅ Enviar Regalito nos ayuda a seguir",
          "‚≠ê √önete a Super Fans $1/mes"
        ]
      }, {merge:true});
    }

    // settings/current
    var s = await settingsRef.get();
    if(!s.exists){
      await settingsRef.set({
        programName:"AutoDJ Coravox",
        programId:"autodj_coravox",
        tz:"America/New_York",
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }

    // programs/autodj_coravox
    var p = await programsRef.doc("autodj_coravox").get();
    if(!p.exists){
      await programsRef.doc("autodj_coravox").set({
        name:"AutoDJ Coravox",
        active:true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }
  }

  // ===========================
  // Config/global
  // ===========================
  var adsMessages = [];

  async function loadConfig(){
    try{
      var snap = await cfgRef.get();
      var d = snap.exists ? snap.data() : {};

      $("cfgBadge").textContent = "ok";
      $("cfgBadge").className = "badge on";

      $("togChat").checked = (d.chatEnabled !== false);
      $("togLikes").checked = (d.likesEnabled !== false);
      $("togPresence").checked = (d.presenceEnabled !== false);
      $("togRequests").checked = (d.allowRequests !== false);

      $("togAds").checked = (d.adsEnabled === true);
      $("adsIntervalSec").value = (d.adsIntervalSec || 20);

      adsMessages = Array.isArray(d.adsMessages) ? d.adsMessages.slice() : [];
      renderAdsList();
    }catch(e){
      $("cfgBadge").textContent = "error";
      $("cfgBadge").className = "badge off";
      $("cfgMsg").textContent = "Error: " + (e.message||e);
    }
  }

  $("btnSaveCfg").addEventListener("click", async function(){
    try{
      await cfgRef.set({
        chatEnabled: !!$("togChat").checked,
        likesEnabled: !!$("togLikes").checked,
        presenceEnabled: !!$("togPresence").checked,
        allowRequests: !!$("togRequests").checked,
        adsEnabled: !!$("togAds").checked,
        adsIntervalSec: Number($("adsIntervalSec").value || 20),
        adsMessages: adsMessages.map(x=>(x||"").trim()).filter(x=>x)
      }, {merge:true});
      $("cfgMsg").textContent = "Guardado ‚úÖ";
      setTimeout(()=>{$("cfgMsg").textContent="";}, 1500);
      toast("Guardado ‚úÖ");
    }catch(e){
      $("cfgMsg").textContent = "Error: " + (e.message||e);
    }
  });

  $("btnReloadCfg").addEventListener("click", loadConfig);

  $("btnForceReloadAds").addEventListener("click", async function(){
    try{
      await cfgRef.set({ adsForceReloadAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
      toast("Refresco forzado ‚úÖ");
    }catch(e){
      toast("Error forcing reload");
    }
  });

  function renderAdsList(){
    var box = $("adsList");
    box.innerHTML = "";
    if(!adsMessages.length){
      box.innerHTML = "<div class='muted'>No hay mensajes.</div>";
      return;
    }

    adsMessages.forEach((msg,i)=>{
      var row = document.createElement("div");
      row.className = "item";

      var main = document.createElement("div");
      main.className = "itemMain";
      main.innerHTML = "<div class='muted'>#"+(i+1)+"</div><textarea class='field' data-i='"+i+"'>"+(msg||"")+"</textarea>";

      var btns = document.createElement("div");
      btns.className = "itemBtns";

      var up = document.createElement("button");
      up.className = "miniBtn";
      up.textContent = "‚Üë";
      up.onclick = ()=>{ if(i===0) return; var t=adsMessages[i-1]; adsMessages[i-1]=adsMessages[i]; adsMessages[i]=t; renderAdsList(); };

      var down = document.createElement("button");
      down.className = "miniBtn";
      down.textContent = "‚Üì";
      down.onclick = ()=>{ if(i===adsMessages.length-1) return; var t=adsMessages[i+1]; adsMessages[i+1]=adsMessages[i]; adsMessages[i]=t; renderAdsList(); };

      var del = document.createElement("button");
      del.className = "miniBtn danger";
      del.textContent = "Eliminar";
      del.onclick = ()=>{ adsMessages.splice(i,1); renderAdsList(); };

      btns.appendChild(up); btns.appendChild(down); btns.appendChild(del);
      row.appendChild(main); row.appendChild(btns);
      box.appendChild(row);
    });

    Array.from(box.querySelectorAll("textarea")).forEach(ta=>{
      ta.addEventListener("input", ()=>{
        adsMessages[Number(ta.getAttribute("data-i"))] = ta.value;
      });
    });
  }

  $("btnAddAdMsg").addEventListener("click", function(){
    var t = ($("newAdMsg").value||"").trim();
    if(!t) return;
    adsMessages.push(t);
    $("newAdMsg").value="";
    renderAdsList();
  });

  // ===========================
  // ON AIR
  // ===========================
  async function loadOnAir(){
    try{
      var c = await cfgRef.get();
      var cfg = c.exists ? c.data() : {};
      currentProgramName = (cfg.currentProgram || "AutoDJ Coravox").toString();
      currentProgramKey  = slugify(currentProgramName);

      $("onAirName").textContent = currentProgramName;
      $("onAirKey").textContent = currentProgramKey;
      $("onAirBadge").textContent = "ok";
      $("onAirBadge").className = "badge on";

      $("presencePath").textContent = "programs/"+currentProgramKey+"/presence";

      // tambi√©n reflejamos settings/current
      await settingsRef.set({
        programName: currentProgramName,
        programId: currentProgramKey,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});

    }catch(e){
      $("onAirBadge").textContent = "error";
      $("onAirBadge").className = "badge off";
    }
  }

  $("btnReloadOnAir").addEventListener("click", loadOnAir);

  $("btnForceAutodj").addEventListener("click", async function(){
    await cfgRef.set({
      currentProgram:"AutoDJ Coravox",
      activeDj:"AutoDJ Coravox"
    }, {merge:true});
    await loadOnAir();
    toast("AutoDJ ON AIR ‚úÖ");
  });

  // ===========================
  // Programs list
  // ===========================
  async function loadPrograms(){
    var box = $("programList");
    box.innerHTML = "<div class='muted'>Cargando‚Ä¶</div>";

    var snap = await programsRef.orderBy("name","asc").get();
    if(snap.empty){
      box.innerHTML = "<div class='muted'>No hay programas.</div>";
      return;
    }

    box.innerHTML = "";
    snap.forEach(function(doc){
      var d = doc.data() || {};
      var progId = doc.id;
      var name = d.name || progId;
      var active = (d.active !== false);

      var row = document.createElement("div");
      row.className = "item";

      var main = document.createElement("div");
      main.className = "itemMain";
      main.innerHTML =
        "<div style='font-weight:900;color:#fff'>"+name+"</div>" +
        "<div class='muted'>ID: <span class='badge'>"+progId+"</span> " +
        (active ? "<span class='badge on'>Activo</span>" : "<span class='badge off'>Inactivo</span>") +
        "</div>";

      var btns = document.createElement("div");
      btns.className = "itemBtns";

      var onAir = document.createElement("button");
      onAir.className = "miniBtn";
      onAir.textContent = "Poner ON AIR";
      onAir.onclick = async ()=>{
        await cfgRef.set({
          currentProgram: name,
          activeDj: name
        }, {merge:true});
        await settingsRef.set({
          programName: name,
          programId: slugify(name),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
        toast("ON AIR: "+name);
        await loadOnAir();
      };

      var toggle = document.createElement("button");
      toggle.className = "miniBtn";
      toggle.textContent = active ? "Desactivar" : "Activar";
      toggle.onclick = async ()=>{
        await programsRef.doc(progId).set({ active: !active }, {merge:true});
        toast("Actualizado ‚úÖ");
        await loadPrograms();
      };

      var del = document.createElement("button");
      del.className = "miniBtn danger";
      del.textContent = "Borrar";
      del.onclick = async ()=>{
        if(!confirm("¬øBorrar programa "+name+"?")) return;
        await programsRef.doc(progId).delete();
        toast("Borrado");
        await loadPrograms();
      };

      btns.appendChild(onAir);
      btns.appendChild(toggle);
      btns.appendChild(del);

      row.appendChild(main);
      row.appendChild(btns);
      box.appendChild(row);
    });
  }

  $("btnCreateProgram").addEventListener("click", async function(){
    var name = ($("progName").value||"").trim();
    if(!name){ toast("Escribe un nombre"); return; }
    var id = slugify(name);
    await programsRef.doc(id).set({
      name:name,
      active:true,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    $("progName").value="";
    toast("Programa creado ‚úÖ");
    await loadPrograms();
  });

  // ===========================
  // Presence watcher (program ON AIR)
  // ===========================
  var presenceTimer = null;

  function startPresenceWatcher(){
    if(presenceTimer) clearInterval(presenceTimer);
    presenceTimer = setInterval(refreshPresence, 8000);
    refreshPresence();
  }

  async function refreshPresence(){
    try{
      await loadOnAir();
      var ref = progPresenceRef();
      var cutoff = Date.now() - 90000;

      var snap = await ref.where("lastSeenMs", ">", cutoff).get();
      $("presenceBadge").textContent = snap.size + " conectados";
      $("presenceBadge").className = snap.size ? "badge on" : "badge";

      var box = $("presenceList");
      box.innerHTML = "";

      if(snap.empty){
        box.innerHTML = "<div class='muted'>Nadie conectado ahora.</div>";
        return;
      }

      var rows = [];
      snap.forEach(doc=>{
        var d = doc.data()||{};
        rows.push({name:d.name||"Oyente", lastSeenMs:d.lastSeenMs||0});
      });
      rows.sort((a,b)=>b.lastSeenMs - a.lastSeenMs);

      rows.forEach(r=>{
        var sec = Math.max(0, Math.floor((Date.now()-r.lastSeenMs)/1000));
        var div = document.createElement("div");
        div.className="item";
        div.innerHTML =
          "<div class='itemMain'><div style='font-weight:900'>"+r.name+"</div><div class='muted'>hace "+sec+"s</div></div>";
        box.appendChild(div);
      });
    }catch(e){
      $("presenceBadge").textContent = "error";
      $("presenceBadge").className = "badge off";
    }
  }

  // ===========================
  // Tools (delete)
  // ===========================
  async function deleteBatch(colRef, limit){
    var snap = await colRef.limit(limit||450).get();
    if(snap.empty) return 0;
    var batch = db.batch();
    snap.docs.forEach(d=>batch.delete(d.ref));
    await batch.commit();
    return snap.size;
  }

  async function clearProgramChat(){
    var n = await deleteBatch(progChatRef(), 450);
    return n;
  }
  async function resetProgramFans(){
    var n = await deleteBatch(progLikesRef(), 450);
    return n;
  }
  async function clearProgramPresence(){
    var n = await deleteBatch(progPresenceRef(), 450);
    return n;
  }

  $("btnClearChat").addEventListener("click", async function(){
    $("toolMsg").textContent = "Limpiando chat‚Ä¶";
    try{
      await loadOnAir();
      var nProg = await clearProgramChat();
      var nLegacy = 0;
      if($("togLegacyTools").checked){
        nLegacy = await deleteBatch(legacyChatRef, 450);
      }
      $("toolMsg").textContent = "OK ‚úÖ programa="+nProg+" legacy="+nLegacy;
      toast("Chat limpiado");
    }catch(e){
      $("toolMsg").textContent = "Error: "+(e.message||e);
    }
  });

  $("btnResetFans").addEventListener("click", async function(){
    $("toolMsg").textContent = "Reseteando top fans‚Ä¶";
    try{
      await loadOnAir();
      var nProg = await resetProgramFans();
      var nLegacy = 0;
      if($("togLegacyTools").checked){
        nLegacy = await deleteBatch(legacyLikesRef, 450);
      }
      $("toolMsg").textContent = "OK ‚úÖ programa="+nProg+" legacy="+nLegacy;
      toast("TopFans reseteado");
    }catch(e){
      $("toolMsg").textContent = "Error: "+(e.message||e);
    }
  });

  $("btnClearPresence").addEventListener("click", async function(){
    $("toolMsg").textContent = "Limpiando presence‚Ä¶";
    try{
      await loadOnAir();
      var nProg = await clearProgramPresence();
      var nLegacy = 0;
      if($("togLegacyTools").checked){
        nLegacy = await deleteBatch(legacyPresenceRef, 450);
      }
      $("toolMsg").textContent = "OK ‚úÖ programa="+nProg+" legacy="+nLegacy;
      toast("Presence limpio");
    }catch(e){
      $("toolMsg").textContent = "Error: "+(e.message||e);
    }
  });

</script>
</body>
</html>
